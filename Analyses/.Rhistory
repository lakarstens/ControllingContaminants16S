mock_ps_pure<-prune_taxa(mock_taxa,mock_ps_pure)
# Chunk 6
# display a summary of the mock community dilution series phyloseq object
mock_ps
# Chunk 7
# create a phyloseq object that is normalized to 100 (relative abundance)
ps_norm <- transform_sample_counts(ps,function(x) 100* x/sum(x))
mock_ps_norm <- transform_sample_counts(mock_ps,function(x) 100* x/sum(x))
# Identify the proportion of each sample that is the expected mock community ASVs
ps_norm_exp <- prune_taxa(mock_taxa,ps_norm)
# Create a table with the dilution, number of reads per sample, and proportion of contaminants per sample
dilutionSummary <- data.frame(DilutionSeries = sample_names(ps),NumberOfReads = sample_sums(ps), PercentContaminants = 100-sample_sums(ps_norm_exp))
# Create a variable to indicate the sample order of the plots
dilutions<-c('D0','D1','D2','D3','D4','D5','D6','D7','D8', 'Blank')
# Create plots to summarize these data
## Plot Figure 1A - number of reads per sample across dilution series
dilutionSummary %>% subset(DilutionSeries %in% dilutions[1:9] ) %>%
ggplot(., aes(x = DilutionSeries, y = NumberOfReads)) + geom_bar(stat="identity", fill="steelblue") +
theme_minimal() + scale_x_discrete(limits = dilutions) +
labs(x = "Dilution Series", y = "Number of Reads") +
theme(axis.text = element_text(size = 14),
axis.title = element_text(size = 16),
plot.title = element_text(size = 16))
## Plot Figure 1B - Percent of contaminants across dilution series
dilutionSummary %>% subset(DilutionSeries %in% dilutions[1:9] ) %>%
ggplot(., aes(x = DilutionSeries, y = PercentContaminants)) + geom_point(size = 3) +
scale_x_discrete(limits = dilutions) +
labs(x = "Dilution Series", y = "Number of Reads") +
theme(axis.text = element_text(size = 14),
axis.title = element_text(size = 16),
plot.title = element_text(size = 16))
## Plot Figure 1C - Stacked bar plot of Mock microbial dilution series
expCompBarPlot(ps_norm, mock_taxa, 'Initial Mock Microbial Community Dilution')  + scale_x_discrete(limits = dilutions)
## Table 1
# Number of sequences per sample
sample_sums(mock_ps)
# number of ASVs per sample
temp <- as.data.frame(ps@otu_table)
temp[temp >0] <- 1
rowSums(temp)
# number of known genera per sample
temp_genus <- tax_glom(ps, "Genus")
temp_genus <- as.data.frame(temp_genus@otu_table)
# change to binary to count unique genera per sample
temp_genus[temp_genus >0] <- 1
rowSums(temp_genus)
# Chunk 8
# subset the normalized blank control sample
blank_ps_norm <- subset_samples(ps_norm,sample_names(ps_norm) %in% c('Blank'))
blank_ps_norm <- prune_taxa(taxa_sums(blank_ps_norm) > 0, blank_ps_norm)
blank_ps_norm
# 655 unique ASVs
#identify ASVs from mock community present in blank
table(taxa_names(blank_ps_norm) %in% mock_taxa)
# Get genera present with >5% abundance
blank_ps_norm %>% subset_taxa(taxa_names(blank_ps_norm) %in% taxa_names(mock_ps_pure)) %>% psmelt() %>% select(Abundance, Family, Genus)
# Collapse at the genus level, keeping unassigned genera
blank_ps_norm <- tax_glom(blank_ps_norm, "Genus", NArm = FALSE)
blank_ps_norm
blank_ps_norm_melt <- psmelt(blank_ps_norm)
# Get genera present with >5% abundance
blank_ps_norm_melt %>% filter(Abundance > 5) %>% select(Abundance, Family, Genus)
# Get genera present with abundance between 1 and 5%
blank_ps_norm_melt %>% filter(Abundance <= 5) %>% filter(Abundance > 1) %>% select(Abundance, Family, Genus)
# Chunk 9
# create a list of unexpected sequences (contaminants)
# create a list of all ASV taxa names
contaminant_taxa<-taxa_names(mock_ps)
# remove the expected mock community ASV taxa names
contaminant_taxa <- contaminant_taxa[!(contaminant_taxa %in% mock_taxa)]
# create a phyloseq object that only contains the contaminant sequences (for use with sourcetracker)
contaminants_ps<-prune_taxa(contaminant_taxa,mock_ps)
contaminants_ps<- prune_taxa(taxa_sums(contaminants_ps)>0,contaminants_ps)
# change the sample names to indicate that these samples only contain contmaminant ASVs
sample_names(contaminants_ps)<-paste('con',sample_names(contaminants_ps),sep = '_')
sample_data(contaminants_ps)$SampleType<-'ContaminantProfile'
# create phyloseq object from normalized data to summarize contamiant contribution
contaminants_ps_norm<-prune_taxa(contaminant_taxa,mock_ps_norm)
contaminants_ps_norm<- prune_taxa(taxa_sums(contaminants_ps_norm)>0,contaminants_ps_norm)
# abundance of contaminant ASVs with > 1% abundance
temp <- as.data.frame(contaminants_ps_norm@otu_table)
temp[temp<1] <- 0
View(temp)
rowSums(temp)
# abundance of contaminant ASVs with > 1% abundance
temp <- as.data.frame(contaminants_ps_norm@otu_table)
rowSums(temp)
temp_ncon <- temp
temp_ncon[temp>0] <- 1
rowSums(temp_ncon)
# number of contaminants per sample > 1% abundance
temp_ncon[temp>0] <- 1
temp[temp >0] <- 1
rowSums(temp)
# abundance of contaminant ASVs with > 1% abundance
temp <- as.data.frame(contaminants_ps_norm@otu_table)
temp_ncon <- temp
temp_ncon[temp>0] <- 1
# number of contamiants per sample
rowSums(temp_ncon)
# number of contaminants per sample > 1% abundance
temp[temp<1] <- 0
temp[temp >0] <- 1
rowSums(temp)
# abundance of contaminant ASVs with > 1% abundance
temp <- as.data.frame(contaminants_ps_norm@otu_table)
temp_ncon <- temp
temp_ncon[temp>0] <- 1
# number of contamiants per sample
rowSums(temp_ncon)
# number of contaminants per sample > 1% abundance
temp[temp<1] <- 0
rowSums(temp)
## Load the dataset
load("mockDilutions.RData")
asv_key <- as.data.frame(asv_key)
save.image("~/Box Sync/KarstensLab/ControllingContaminants16S/Analyses/mockDilutions.RData")
# Chunk 1: setup
knitr::opts_chunk$set(echo = TRUE)
# Chunk 2
# load libraries
library(tidyr)
library(dplyr)
library(kableExtra)
library(ggplot2)
library(ggpubr)
load('results_filtering.RData')
load('results_decontam.RData')
load('results_sourcetracker.RData')
# Chunk 3
# Change the method in results_original to better match terminology used with other methods. (current is "Original Data")
results_original$method <- 'Uncorrected Results'
# Add prevalence to the original data and expected data (for plotting)
results_original$prevalence <- results_filter_0_1$prevalence
results_expected$prevalence <- results_filter_0_1$prevalence
# Chunk 4
# create massive data table with all results
results_all <- bind_rows(results_original,results_expected, results_blank, results_decontam_0_1,results_decontam_0_2,results_decontam_0_3, results_decontam_0_4, results_decontam_0_5, results_filter_0_01, results_filter_0_1, results_filter_1, results_st_sc1_case1, results_st_sc1_case2,results_st_sc2_case1, results_st_sc2_case2 )
# change 'Blank control removal' to 'Negative control filter' to reflect the manuscript
results_all <- results_all %>%
mutate(method = recode_factor(method,`Blank control removal`= 'Negative control filter'))
# change NAs to 0 (confrimed that NAs are only due to ASVs removed from blank control removal)
results_all[is.na(results_all)] <- 0
# resubset results_blank so it has all expected ASVs (ASVs that are not represented in the data set are now 0)
results_blank <- results_all %>%
filter(method == 'Negative control filter')
# reorder to be contistent with the rest of the resulst file
## probably to figure out how to do this better
results_blank <- results_blank[,c(17,18,1:14,19:22,15,16)]
# order the methods
results_all$method <- factor(results_all$method, levels = c("Uncorrected Results", "Expected Results" ,"Negative control filter", "Abundance filter, 0.01","Abundance filter, 0.1", "Abundance filter, 1", "Decontam frequency, thr =0.1", "Decontam frequency, thr =0.2", "Decontam frequency, thr =0.3", "Decontam frequency, thr =0.4", "Decontam frequency, thr =0.5", "SourceTracker, scenario 1 case 1", "SourceTracker, scenario 1 case 2","SourceTracker, scenario 2 case 1", "SourceTracker, scenario 2 case 2"))
# create a column for contaminant removal method type
results_all <- results_all %>%  mutate(method_type = gsub(',.*', '', method))
# order the method types
results_all$method_type <- factor(results_all$method_type, levels = c("Uncorrected Results", "Expected Results" ,"Negative control filter", "Abundance filter", "Decontam frequency","SourceTracker"))
View(results_all)
results_removed <- results_all %>%
select(contaminants_removed, mock_ASVs_removed, method, method_type, sample_names)
View(results_removed)
results_removed <- results_all %>%
select(contaminants_removed, mock_ASVs_removed, method, method_type, sample_names) %>%
spread(sample_names)
results_removed <- results_all %>%
select(contaminants_removed, mock_ASVs_removed, method, method_type, sample_names) %>%
spread(sample_names)
results_removed <- results_all %>%
select(contaminants_removed, mock_ASVs_removed, method, method_type, sample_names) %>%
spread(sample_names,contaminants_removed, mock_ASVs_removed)
results_removed <- results_all %>%
select(contaminants_removed, mock_ASVs_removed, method, method_type, sample_names) %>%
spread(sample_names,contaminants_removed, mock_ASVs_removed)
results_removed <- results_all %>%
select(contaminants_removed, mock_ASVs_removed, method, method_type, sample_names) %>%
spread(.,sample_names,contaminants_removed, mock_ASVs_removed)
results_removed <- results_all %>%
select(contaminants_removed, mock_ASVs_removed, method, method_type, sample_names) %>%
spread(.,sample_names,contaminants_removed)
results_contamiants_removed <- results_all %>%
select(contaminants_removed, method, method_type, sample_names) %>%
spread(.,sample_names,contaminants_removed)
results_mock_ASVs_removed <- results_all %>%
select( mock_ASVs_removed, method, method_type, sample_names) %>%
spread(.,sample_names,mock_ASVs_removed)
View(results_contamiants_removed)
View(results_mock_ASVs_removed)
sessionInfo()
library(dada2)
library(phyloseq)
sessionInfo()
library(decontam)
sessionInfo()
customPalette <- c("#1F78B4", "#A6CEE3", "#33A02C", "#B2DF8A", "#E31A1C", "#FB9A99", "#FF7F00", "#FDBF6F", "#6A3D9A", "#d3d3d3")
long_profile <- classification_data %>%
filter(method_type %in% c('Uncorrected Results', 'Abundance filter', 'Negative control filter')) %>%
select(ASV_1, ASV_2, ASV_3, ASV_4, ASV_5, ASV_6, ASV_7, ASV_8, ASV_10, con_abundance,sample_names, method, method_type) %>%
gather(key = 'SequenceClass',value = 'Abundance', -sample_names, -method, - method_type)
# Chunk 1: setup
knitr::opts_chunk$set(echo = TRUE)
# Chunk 2
# load libraries
library(tidyr)
library(dplyr)
library(kableExtra)
library(ggplot2)
library(ggpubr)
load('results_filtering.RData')
load('results_decontam.RData')
load('results_sourcetracker.RData')
# Chunk 3
# Change the method in results_original to better match terminology used with other methods. (current is "Original Data")
results_original$method <- 'Uncorrected Results'
# Add prevalence to the original data and expected data (for plotting)
results_original$prevalence <- results_filter_0_1$prevalence
results_expected$prevalence <- results_filter_0_1$prevalence
# Chunk 4
# create massive data table with all results
results_all <- bind_rows(results_original,results_expected, results_blank, results_decontam_0_1,results_decontam_0_2,results_decontam_0_3, results_decontam_0_4, results_decontam_0_5, results_filter_0_01, results_filter_0_1, results_filter_1, results_st_sc1_case1, results_st_sc1_case2,results_st_sc2_case1, results_st_sc2_case2 )
# change 'Blank control removal' to 'Negative control filter' to reflect the manuscript
results_all <- results_all %>%
mutate(method = recode_factor(method,`Blank control removal`= 'Negative control filter'))
# change NAs to 0 (confrimed that NAs are only due to ASVs removed from blank control removal)
results_all[is.na(results_all)] <- 0
# resubset results_blank so it has all expected ASVs (ASVs that are not represented in the data set are now 0)
results_blank <- results_all %>%
filter(method == 'Negative control filter')
# reorder to be contistent with the rest of the resulst file
## probably to figure out how to do this better
results_blank <- results_blank[,c(17,18,1:14,19:22,15,16)]
# order the methods
results_all$method <- factor(results_all$method, levels = c("Uncorrected Results", "Expected Results" ,"Negative control filter", "Abundance filter, 0.01","Abundance filter, 0.1", "Abundance filter, 1", "Decontam frequency, thr =0.1", "Decontam frequency, thr =0.2", "Decontam frequency, thr =0.3", "Decontam frequency, thr =0.4", "Decontam frequency, thr =0.5", "SourceTracker, scenario 1 case 1", "SourceTracker, scenario 1 case 2","SourceTracker, scenario 2 case 1", "SourceTracker, scenario 2 case 2"))
# create a column for contaminant removal method type
results_all <- results_all %>%  mutate(method_type = gsub(',.*', '', method))
# order the method types
results_all$method_type <- factor(results_all$method_type, levels = c("Uncorrected Results", "Expected Results" ,"Negative control filter", "Abundance filter", "Decontam frequency","SourceTracker"))
# Chunk 5
# Create a pretty subset of ASV-only data for plotting
results_asv_long <- results_all %>%
select(contains("ASV_"),sample_names, method, method_type) %>%
gather(key = 'ASV',value = 'Abundance', -sample_names, -method, - method_type)
# Create a small subset of the result data representing low, moderate, and high levels of contaminants for plotting
results_limited <- results_all %>%
filter(sample_names %in% c('D3','D6','D8'))
results_asv_limited_long <-  results_limited %>%
select(contains("ASV_"),sample_names, method, method_type) %>%
gather(key = 'ASV',value = 'Abundance', -sample_names, -method, - method_type)
# subset out the expected and uncorrected data
exp_uncor_data <- results_all %>% filter(method %in% c('Expected Results', 'Uncorrected Results')) %>%
select(Observed, InvSimpson, Shannon,method, method_type, sample_names, prevalence) %>%
gather(key = 'alpha_diversity_measure',value = 'Value', -sample_names, -method, - method_type, - prevalence)
# Chunk 6
# Figure 4 - Accuracy faceted by method type (in manuscript)
color_palette <- c(`1` ="#3182bd", `2` ="#fd8d3c" , `3` = "#d95f02", `4` =  "#a63603", `5` =  "#bcbddc" ,`6` = "#9e9ac8", `7`= "#807dba", `8` ="#6a51a3" , `9` = "#4a1486", `10`=  "#99d8c6", `12` = "#66c2a4", `13` ="#2ca25f", `14` = "#006d2c")
results_all %>% filter (method_type %in% c('Negative control filter','Abundance filter','Decontam frequency','SourceTracker')) %>%
ggplot(., aes(x = prevalence, y = accuracy, color = method)) +
geom_line() + geom_point() + facet_grid(~method_type) +
theme(legend.position = "right", legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 14),
plot.title = element_text(size = 14),
strip.text.x = element_text(size = 14)) +
scale_color_manual(values = unname(color_palette)) +
labs(x = "Contaminant Prevalence", y = "Accuracy")
# Chunk 7
# Sensitivity (not in manuscript)
results_all %>% filter (method_type %in% c('Negative control filter','Abundance filter','Decontam frequency','SourceTracker')) %>%
ggplot(., aes(x = prevalence, y = sensitivity, color = method)) +
geom_line() + geom_point() + facet_grid(~method_type) +
theme(legend.position = "right", legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 14),
plot.title = element_text(size = 14),
strip.text.x = element_text(size = 14)) +
scale_color_manual(values = unname(color_palette))
# Chunk 8
# Alpha diversity dataframe
results_all_alpha <- results_all %>% filter (method_type %in% c('Expected Results', 'Uncorrected Results','Negative control filter','Abundance filter','Decontam frequency','SourceTracker')) %>%
select(Observed, InvSimpson, Shannon,method, method_type, sample_names, prevalence) %>%
gather(key = 'alpha_diversity_measure',value = 'Value', -sample_names, -method, - method_type, - prevalence) %>%
mutate(alpha_diversity_measure = factor(alpha_diversity_measure, levels = c('Observed', 'InvSimpson', 'Shannon')))
# Figure 2 - Alpha diversity plots for expected and uncorrected results
results_all_alpha %>% filter (method_type %in% c('Expected Results', 'Uncorrected Results')) %>%
ggplot(., aes(x = sample_names, y = Value, shape = method)) +
geom_point() + facet_wrap(~alpha_diversity_measure, scales = "free_y") +
theme(legend.position = "right", legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 16),
plot.title = element_text(size = 16),
strip.text.x = element_text(size = 14))
# Chunk 9
# Alpha diversity for all (supplemental)
results_all_alpha %>% filter (method_type %in% c('Negative control filter','Abundance filter','Decontam frequency','SourceTracker')) %>%
filter(alpha_diversity_measure == 'Observed') %>%
ggplot(., aes(x = sample_names, y = Value, color = method)) +
geom_point() + facet_wrap(~method_type, ncol = 6) +
theme(legend.position = "right", legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 12),
plot.title = element_text(size = 12),
strip.text.x = element_text(size = 12)) +
scale_color_manual(values = unname(color_palette))
results_all_alpha %>% filter (method_type %in% c('Negative control filter','Abundance filter','Decontam frequency','SourceTracker')) %>%
filter(alpha_diversity_measure == 'InvSimpson') %>%
ggplot(., aes(x = sample_names, y = Value, color = method)) +
geom_point() + facet_wrap(~method_type, ncol = 4) +
theme(legend.position = "right", legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 12),
plot.title = element_text(size = 12),
strip.text.x = element_text(size = 12)) +
scale_color_manual(values = unname(color_palette))
results_all_alpha %>% filter (method_type %in% c('Negative control filter','Abundance filter','Decontam frequency','SourceTracker')) %>%
filter(alpha_diversity_measure == 'Shannon') %>%
ggplot(., aes(x = sample_names, y = Value, color = method)) +
geom_point() + facet_wrap(~method_type, ncol = 4) +
theme(legend.position = "right", legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 12),
plot.title = element_text(size = 12),
strip.text.x = element_text(size = 12)) +
scale_color_manual(values = unname(color_palette))
# Chunk 10
# representative
results_asv_limited_long %>% filter(ASV == 'ASV_1') %>%
filter (method_type %in% c('Abundance filter','Decontam frequency','SourceTracker', 'Negative control filter')) %>%
ggplot(., aes(x = method, y = Abundance, fill = method)) +   geom_bar(stat = 'identity') + facet_wrap(~sample_names , ncol = 9) + theme(axis.text.x = element_text(angle = 90, hjust = 1))  + ylim(0,35) +   scale_fill_manual(values = unname(color_palette)) +
geom_hline(data = results_asv_limited_long %>% filter(method %in% c('Expected Results'), ASV == 'ASV_1'), aes(yintercept = Abundance, linetype ="Expected Results*"),  show.legend = TRUE, color = 'black') +
theme(legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 16),
plot.title = element_text(size = 16),
strip.text.x = element_text(size = 14))
# representative
results_asv_limited_long %>% filter(ASV == 'ASV_2') %>%
filter (method_type %in% c('Abundance filter','Decontam frequency','SourceTracker', 'Negative control filter')) %>%
ggplot(., aes(x = method, y = Abundance, fill = method)) +
geom_bar(stat = 'identity') + facet_wrap(~sample_names , ncol = 9) +
theme(axis.text.x = element_text(angle = 90, hjust = 1))  + ylim(0,30) +
scale_fill_manual(values = unname(color_palette)) +
geom_hline(data = results_asv_limited_long %>% filter(method %in% c('Expected Results'), ASV == 'ASV_2'), aes(yintercept = Abundance, linetype ="Expected Results*"),  show.legend = TRUE, color = 'black') +
theme(legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 16),
plot.title = element_text(size = 16),
strip.text.x = element_text(size = 14))
# representative
results_limited %>%
filter (method_type %in% c('Abundance filter','Decontam frequency','SourceTracker', 'Negative control filter')) %>%
ggplot(., aes(x = method, y = InvSimpson, fill = method) )+   geom_bar( stat = "identity") +  facet_wrap(~sample_names , ncol = 9) + theme(axis.text.x = element_text(angle = 90, hjust = 1))  + scale_fill_manual(values = unname(color_palette)) + geom_hline(data = results_limited %>% filter(method %in% c('Expected Results')), aes(yintercept = InvSimpson, linetype ="Expected Results*"),  show.legend = TRUE, color = 'black') +
theme(legend.title = element_text(size = 12),
axis.text = element_text(size = 12),
axis.title = element_text(size = 16),
plot.title = element_text(size = 16),
strip.text.x = element_text(size = 14))
# Chunk 11
library(gtable)
library(grid)
customPalette <- c('#969696','#bdbdbd', '#d6604d', '#4393c3')
### Individual plots for publication
# Filter methods
classification_data <- results_all %>%
mutate(method = plyr::revalue(method, c("Uncorrected Results" = "A. No filter", "Expected Results" = "Expected Results",  "Negative control filter" = "B. Negative control filter", "Abundance filter, 0.01"  = "C. Abundance filter, 0.01" , "Abundance filter, 0.1" = "D. Abundance filter, 0.1" ,"Abundance filter, 1"  = "E. Abundance filter, 1.0" , "Decontam frequency, thr =0.1" = "F. Threshold = 0.1", "Decontam frequency, thr =0.2" = "G. Threshold = 0.2", "Decontam frequency, thr =0.3" = "H. Threshold = 0.3",  "Decontam frequency, thr =0.4" = "I. Threshold = 0.4", "Decontam frequency, thr =0.5" = "J. Threshold = 0.5" ,  "SourceTracker, scenario 1 case 1" =  "K. Scenario 1, case 1", "SourceTracker, scenario 1 case 2" = "L. Scenario 1, case 2", "SourceTracker, scenario 2 case 1" =  "M. Scenario 2, case 1", "SourceTracker, scenario 2 case 2" =  "N. Scenario 2, case 2")))
long_profile <- classification_data %>%
filter(method_type %in% c('Uncorrected Results', 'Abundance filter', 'Negative control filter')) %>%
select(true_pos, true_neg, false_pos, false_neg, sample_names, method, method_type) %>%
gather(key = 'SequenceClass',value = 'Abundance', -sample_names, -method, - method_type)
# Figures
classificationPlot_filter <- ggplot(long_profile, aes(x = sample_names, y = Abundance)) + facet_wrap(~method, ncol = 5) +
geom_col(aes(fill = SequenceClass), width = 0.7, position = position_fill())  +
scale_fill_manual(values=customPalette, ) + theme(text = element_text(size=14)) +
labs(x = NULL, y = 'Proportion of Reads') +
theme(legend.position = "none",
axis.text = element_text(size = 10),
axis.title = element_text(size = 12),
plot.title = element_text(size = 18))
# Decontam methods
long_profile <- classification_data %>%
filter(method_type %in% c('Decontam frequency')) %>%
select(true_pos, true_neg, false_pos, false_neg, sample_names, method, method_type) %>%
gather(key = 'SequenceClass',value = 'Abundance', -sample_names, -method, - method_type)
# Figures
classificationPlot_decontam <- ggplot(long_profile, aes(x = sample_names, y = Abundance)) + facet_wrap(~method, ncol = 5) +
geom_col(aes(fill = SequenceClass), width = 0.7, position = position_fill())  +
scale_fill_manual(values=customPalette) + theme(text = element_text(size=14)) +
labs(x = NULL, y = 'Proportion of Reads') +
theme(legend.position = "none",
axis.text = element_text(size = 10),
axis.title = element_text(size = 12),
plot.title = element_text(size = 18))
# SourceTracker
long_profile <- classification_data %>%
filter(method_type %in% c('SourceTracker')) %>%
select(true_pos, true_neg, false_pos, false_neg, sample_names, method, method_type) %>%
gather(key = 'SequenceClass',value = 'Abundance', -sample_names, -method, - method_type)
# Figures
classificationPlot_sourcetracker <- ggplot(long_profile, aes(x = sample_names, y = Abundance)) + facet_wrap(~method, ncol = 4) +
geom_col(aes(fill = SequenceClass), width = 0.7, position = position_fill())  +
scale_fill_manual(values=customPalette, labels = c("Mock community (incorrect)","Contaminants (incorrect)", "Mock community (correct)", "Contaminants (correct)")) + theme(text = element_text(size=14)) +
labs(x = "Sample", y = 'Proportion of Reads') +
theme(legend.position = "right",
axis.text = element_text(size = 10),
axis.title = element_text(size = 12),
plot.title = element_text(size = 18))
# define text for header
header_label = "Decontam frequency method"
# Get the ggplot grob
z <- ggplotGrob(classificationPlot_decontam)
# Get the positions of the strips in the gtable: t = top
posT <- subset(z$layout, grepl("strip-t", name), select = t:r)
# and a new row on top of plot
height <- z$heights[min(posT$t)]  # height of current top strips
z <- gtable_add_rows(z, height, min(posT$t)-1)
# Construct the new strip grobs
stripT <- gTree(name = "Strip_top", children = gList(
rectGrob(gp = gpar(col = NA, fill = "white")),
textGrob(header_label, gp = gpar(fontsize = 11, col = "black"))))
# Position the grobs in the gtable
z <- gtable_add_grob(z, stripT, t = min(posT$t), l = min(posT$l), name = "strip-top")
# Add small gaps between strips
z <- gtable_add_rows(z, unit(1/5, "line"), min(posT$t))
classificationPlot_decontam <- z
# Repeat (TO DO - make into a function)
# Need to figure out how to get the titles right, adding trailing spaces works for now.
header_label = "Filter method                           "
z <- ggplotGrob(classificationPlot_filter)
z <- gtable_add_rows(z, height, min(posT$t)-1)
stripT <- gTree(name = "Strip_top", children = gList(
rectGrob(gp = gpar(col = NA, fill = "white")),
textGrob(header_label, gp = gpar(fontsize = 11, col = "black"))))
z <- gtable_add_grob(z, stripT, t = min(posT$t), l = min(posT$l), name = "strip-top")
z <- gtable_add_rows(z, unit(1/5, "line"), min(posT$t))
classificationPlot_filter <- z
# Repeat (TO DO - make into a function)
header_label = "SourceTracker                     "
z <- ggplotGrob(classificationPlot_sourcetracker)
z <- gtable_add_rows(z, height, min(posT$t)-1)
stripT <- gTree(name = "Strip_top", children = gList(
rectGrob(gp = gpar(col = NA, fill = "white")),
textGrob(header_label, gp = gpar(fontsize = 11, col = "black"))))
z <- gtable_add_grob(z, stripT, t = min(posT$t), l = min(posT$l), name = "strip-top")
z <- gtable_add_rows(z, unit(1/5, "line"), min(posT$t))
classificationPlot_sourcetracker <- z
gridExtra::grid.arrange(classificationPlot_filter, classificationPlot_decontam, classificationPlot_sourcetracker)
# Save
png('classificationPlot.png', , width = 800, height = 800)
gridExtra::grid.arrange(classificationPlot_filter, classificationPlot_decontam, classificationPlot_sourcetracker)
dev.off()
long_profile <- classification_data %>%
filter(method_type %in% c('Uncorrected Results', 'Abundance filter', 'Negative control filter')) %>%
select(ASV_1, ASV_2, ASV_3, ASV_4, ASV_5, ASV_6, ASV_7, ASV_8, ASV_10, con_abundance,sample_names, method, method_type) %>%
gather(key = 'SequenceClass',value = 'Abundance', -sample_names, -method, - method_type)
customPalette <- c("#1F78B4", "#A6CEE3", "#33A02C", "#B2DF8A", "#E31A1C", "#FB9A99", "#FF7F00", "#FDBF6F", "#6A3D9A", "#d3d3d3")
# Figures
composition_filter <- ggplot(long_profile, aes(x = sample_names, y = Abundance)) + facet_wrap(~method, ncol = 5) +
geom_col(aes(fill = SequenceClass), width = 0.7, position = position_fill())  +
scale_fill_manual(values=customPalette, ) + theme(text = element_text(size=14)) +
labs(x = NULL, y = 'Proportion of Reads') +
theme(legend.position = "none",
axis.text = element_text(size = 10),
axis.title = element_text(size = 12),
plot.title = element_text(size = 18))
# Decontam methods
long_profile <- classification_data %>%
filter(method_type %in% c('Decontam frequency')) %>%
select(ASV_1, ASV_2, ASV_3, ASV_4, ASV_5, ASV_6, ASV_7, ASV_8, ASV_10, con_abundance,sample_names, method, method_type) %>%
gather(key = 'SequenceClass',value = 'Abundance', -sample_names, -method, - method_type)
# Figures
composition_decontam <- ggplot(long_profile, aes(x = sample_names, y = Abundance)) + facet_wrap(~method, ncol = 5) +
geom_col(aes(fill = SequenceClass), width = 0.7, position = position_fill())  +
scale_fill_manual(values=customPalette) + theme(text = element_text(size=14)) +
labs(x = NULL, y = 'Proportion of Reads') +
theme(legend.position = "none",
axis.text = element_text(size = 10),
axis.title = element_text(size = 12),
plot.title = element_text(size = 18))
# SourceTracker
long_profile <- classification_data %>%
filter(method_type %in% c('SourceTracker')) %>%
select(ASV_1, ASV_2, ASV_3, ASV_4, ASV_5, ASV_6, ASV_7, ASV_8, ASV_10, con_abundance,sample_names, method, method_type) %>%
gather(key = 'SequenceClassification',value = 'Abundance', -sample_names, -method, - method_type)
# Figures
composition_sourcetracker <- ggplot(long_profile, aes(x = sample_names, y = Abundance)) + facet_wrap(~method, ncol = 4) +
geom_col(aes(fill = SequenceClassification), width = 0.7, position = position_fill())  +
scale_fill_manual(values=customPalette,  labels = c('Lactobacillus','Escherichia/Shigella','Salmonella ASV1','Bacillus','Pseudomonas','Listeria','Enterococcus','Salmonella ASV2','Staphylococcus','Contaminants')) + theme(text = element_text(size=14)) +
labs(x = "Sample", y = 'Proportion of Reads') +
theme(legend.position = "right",
axis.text = element_text(size = 10),
axis.title = element_text(size = 12),
plot.title = element_text(size = 18))
composition_sourcetracker
load("~/Box Sync/KarstensLab/ControllingContaminants16S/Analyses/mockDilutions.RData")
temp <- as.data.frame(mock_ps@tax_table)
View(temp)
# Figures
composition_sourcetracker <- ggplot(long_profile, aes(x = sample_names, y = Abundance)) + facet_wrap(~method, ncol = 4) +
geom_col(aes(fill = SequenceClassification), width = 0.7, position = position_fill())  +
scale_fill_manual(values=customPalette) + theme(text = element_text(size=14)) +
labs(x = "Sample", y = 'Proportion of Reads') +
theme(legend.position = "right",
axis.text = element_text(size = 10),
axis.title = element_text(size = 12),
plot.title = element_text(size = 18))
composition_sourcetracker
# Figures
composition_sourcetracker <- ggplot(long_profile, aes(x = sample_names, y = Abundance)) + facet_wrap(~method, ncol = 4) +
geom_col(aes(fill = SequenceClassification), width = 0.7, position = position_fill())  +
scale_fill_manual(values=customPalette,  labels = c('Lactobacillus','Staphylococcus','Escherichia/Shigella','Salmonella ASV1','Bacillus','Pseudomonas','Listeria','Enterococcus','Salmonella ASV2','Contaminants')) + theme(text = element_text(size=14)) +
labs(x = "Sample", y = 'Proportion of Reads') +
theme(legend.position = "right",
axis.text = element_text(size = 10),
axis.title = element_text(size = 12),
plot.title = element_text(size = 18))
composition_sourcetracker
